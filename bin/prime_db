#!/usr/local/bin/node

// Prime the db with some dummy photo data
const { mongoose, dbConnect, stringify } = require('../lib/utils')

const { PhotoAlbum } = require('../models/PhotoAlbum')

const { User } = require('../models/User')

const photoAlbumsData = [
  {
    active: true,
    year: 2022,
    event_name: 'The Big Event',
    event_date: '2022-01-01',
    photos: [
      {
        caption: 'WTF?',
        location_uri:
          'https://farm66.staticflickr.com/65535/53059598537_7d7e4b51e5_z.jpg'
      }
    ]
  },
  {
    active: true,
    year: 2022,
    event_name: 'Another Big Event',
    event_date: '2022-11-01',
    photos: [
      {
        caption: 'With Pringles',
        location_uri:
          'https://farm66.staticflickr.com/65535/53060663853_22d9597791_z.jpg'
      },
      {
        caption: 'Blue Goo',
        location_uri:
          'https://farm66.staticflickr.com/65535/53060567875_c492264465_z.jpg'
      }
    ]
  },
  {
    active: true,
    year: 2023,
    event_name: 'Still Another Big Event',
    event_date: '2023-01-01',
    photos: [
      {
        caption: 'With Pringles',
        location_uri:
          'https://farm66.staticflickr.com/65535/53060663853_22d9597791_z.jpg'
      },
      {
        caption: 'Blue Goo',
        location_uri:
          'https://farm66.staticflickr.com/65535/53060567875_c492264465_z.jpg'
      }
    ]
  }
]

const usersData = [{
  firstName: 'John',
  lastName: 'User',
  imageUrl: 'http://...',
  kind: 'student',
  grade: 10,
  // slug: 'john-user', // auto-generated
  createdBy: 'unknown',
  updatedBy: 'unknown'
}, {
  firstName: 'Rob',
  lastName: 'Raisch',
  imageUrl: 'http://...',
  kind: 'mentor',
  // slug: 'john-user', // auto-generated
  createdBy: 'unknown',
  updatedBy: 'unknown'
}]

function dieDieDie (msg) {
  console.error(msg)
  process.exit(-1)
}

async function dropPhotoAlbums () {
  console.log('dropping photoalbums')
  try {
    mongoose.connection.dropCollection('photoalbums')
  } catch (err) {
    /* purposefully ignored */
  }
}

async function dropUsers () {
  console.log('dropping users table')
  try {
    mongoose.connection.dropCollection('users')
  } catch (err) {
    /* purposefully ignored */
  }
}

async function primePhotoAlbums () {
  await dropPhotoAlbums()
  photoAlbumsData.forEach(async d => {
    console.log(`working on ${stringify(d)}`)
    const rec = new PhotoAlbum(d)
    await rec.save()
    console.log(`saved album: ${rec}`)
  })
}

async function primeUsers () {
  await dropUsers()
  usersData.forEach(async d => {
    console.log(`working on ${stringify(d)}`)
    const rec = new User(d)
    await rec.save()
    console.log(`saved user: ${rec}`)
  })
}

dbConnect()
  .catch(err => {
    console.error(`failed to connect to mongoose: ${err}`)
    process.exit(-1)
  })
  .then(async () => {
    console.log('priming PhotoAlbums collection...')
    await primePhotoAlbums().catch(err => dieDieDie(err))
  })
  .then(async () => {
    console.log('priming Users collection...')
    await primeUsers().catch(err => dieDieDie(err))
  })
  .then(async () => {
    console.log('waiting to complete')
    setTimeout(() => {
      console.log('complete')
      process.exit(0)
    }, 5000)
  })
