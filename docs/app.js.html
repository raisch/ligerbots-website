<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: app.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: app.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * This is the main entry point for the Ligerbots web server.
 *
 * It provides an HTTP service on port `process.env.PORT` (defaults to 3000) to serve incoming requests from the Internet.
 *
 * @module
 */

// preferred order of requires
//   node modules,
//   external modules,
//   our own modules
//
// then define constants and variables

const express = require('express')
const methodOverride = require('method-override')
const bodyParser = require('body-parser')
const ShortUniqueId = require('short-unique-id')

const { _, croak, croakFactory, dbConnect } = require('./lib/utils')
const routes = require('./routes')

const { API_VERSION, SERVICE_PORT } = require('./etc/constants')

const PORT = process.env.PORT || SERVICE_PORT

const app = express()

/**
 * Extend router response arg with a new templated renderPage function.
 *
 * @example
 * router.get('/path/:page_name', async (req, res) => {
 *    const page = req.param.page_name
 *    res.renderPage(page, `This is the ${page} page.`)
 * })
 */
app.response.renderPage = function (page, title, tmpl = 'template') {
  return this.render(tmpl, {
    title: title || '',
    page: page || 'example'
  })
}

const uid = new ShortUniqueId({ length: 5 })

console.log('starting up...')

app.set('view engine', 'ejs')
app.use(express.urlencoded({ extended: false }))
app.use(methodOverride('_method'))
app.use(bodyParser.json())

// request/response logging middleware
app.use((req, res, next) => {
  const id = uid.rnd()
  const { method, url } = req
  console.log(`${id} &lt;&lt;&lt; ${method} ${url} ${_.get(req, 'headers.host', 'UNKNOWN')}`)
  res.on('finish', () => {
    console.log(`${id} >>> ${res.statusCode} ${res.statusMessage}  [${res._contentLength.toLocaleString()} octets] ${method} ${url}`)
  })
  next()
})

// add routes
console.log('adding main routes')
app.use(routes.main)

_.keys(routes).forEach(key => {
  if (key !== 'main') {
    console.log(`adding templated routes for ${key}`)
    app.use(`/${key}`, routes[key])

    console.log(`adding api routes for ${key}`)
    app.use(`/api/v${API_VERSION}/${key}`, routes[key])
  }
})

// allow service of static assets (from './public')
app.use(express.static('public'))

// catch-all default to 404 page
app.get('*', async (req, res) => {
  res.status(404).render('main/error')
})

// start listening for incoming requests
app.listen(PORT, err => {
  if (err) {
    croak(`failed to start service: ${err}`)
  }

  console.log('connecting to mongo...')
  dbConnect()
    .catch(croakFactory('failed to connect to mongoose'))
    .then(() => console.log('...connected to mongo via mongoose...'))
    .then(() => console.log(`...listening for requests on port ${PORT}`))
})
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-app.html">app</a></li><li><a href="module-models_Album.html">models/Album</a></li><li><a href="module-models_User.html">models/User</a></li><li><a href="module-models_article.html">models/article</a></li><li><a href="module-models_event.html">models/event</a></li><li><a href="module-models_photo.html">models/photo</a></li><li><a href="module-routes_albums.html">routes/albums</a></li><li><a href="module-routes_articles.html">routes/articles</a></li><li><a href="module-routes_events.html">routes/events</a></li><li><a href="module-routes_index.html">routes/index</a></li><li><a href="module-routes_main.html">routes/main</a></li><li><a href="module-routes_photos.html">routes/photos</a></li><li><a href="module-routes_users.html">routes/users</a></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.2</a> on Fri Nov 10 2023 13:37:12 GMT-0500 (Eastern Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
